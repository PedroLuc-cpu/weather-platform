version: "3.8"
services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBIT_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBIT_PASS:-guest}
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      retries: 5

  mongodb:
    image: mongo:6
    container_name: mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      retries: 5

  nest-api:
    build: ./services/nest-api
    container_name: nest-api
    depends_on:
      rabbitmq:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    environment:
      - MONGO_URI=mongodb://mongodb:27017/weatherdb
      - RABBIT_URL=amqp://${RABBIT_USER:-guest}:${RABBIT_PASS:-guest}@rabbitmq:5672/
      - JWT_SECRET=${JWT_SECRET}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASS=${ADMIN_PASS}
    ports:
      - "3000:3000"

  python-producer:
    build: ./services/python-producer
    container_name: python-producer
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_URL=amqp://${RABBIT_USER:-guest}:${RABBIT_PASS:-guest}@rabbitmq:5672/
      - QUEUE_NAME=weather.data
      - LATITUDE=${LATITUDE}
      - LONGITUDE=${LONGITUDE}
      - INTERVAL_SEC=${PUBLISH_INTERVAL_SEC:-3600}
    restart: unless-stopped

  go-worker:
    build: ./services/go-worker
    container_name: go-worker
    depends_on:
      rabbitmq:
        condition: service_healthy
      nest-api:
        condition: service_started
    environment:
      - RABBIT_URL=amqp://${RABBIT_USER:-guest}:${RABBIT_PASS:-guest}@rabbitmq:5672/
      - QUEUE_NAME=weather.data
      - API_ENDPOINT=http://nest-api:3000/api/weather
    restart: unless-stopped

  frontend:
    build: ./services/frontend
    container_name: frontend
    depends_on:
      - nest-api
    environment:
      - VITE_API_URL=http://localhost:3000/api
    ports:
      - "5173:5173"
    command: npm run dev

volumes:
  mongo_data:
